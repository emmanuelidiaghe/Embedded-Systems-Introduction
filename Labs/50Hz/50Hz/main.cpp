/*
 * 50Hz.cpp
 *
 * Created: 24-Mar-20 2:49:43 PM
 * Author : Emancipator
 */ 
#define F_CPU 16000000
#define usingGeneralAVR
#define usingKeypad4X4
#define usingLCD
#define usingADC
#include <avr/io.h>
#include <string.h>
#include <avr/interrupt.h>

#define SD   PA7
#define LED  PC6
#define PWMA PD4
#define PWMB PD5
#define BUZZ PC7

#define keypadPort           PORTB
#define keypadPortDirection  DDRB

#define keypadRow0 PINB_B0
#define keypadRow1 PINB_B1
#define keypadRow2 PINB_B2
#define keypadRow3 PINB_B3
#define keypadCol0 PINB_B4
#define keypadCol1 PINB_B5
#define keypadCol2 PINB_B6
#define keypadCol3 PINB_B7


#define lcdRsDir DDRC_B0
#define lcdEnDir DDRC_B1
#define lcdD4Dir DDRC_B2
#define lcdD5Dir DDRC_B3
#define lcdD6Dir DDRC_B4
#define lcdD7Dir DDRC_B5

#define lcdRs PORTC_B0
#define lcdEn PORTC_B1
#define lcdD4 PORTC_B2
#define lcdD5 PORTC_B3
#define lcdD6 PORTC_B4
#define lcdD7 PORTC_B5

#include "C://Emancipator/Emancipator.h"
lcd display (16,2);

int x      = 0;
int OK     = 0;
int batt   = 0;
int output = 0;
int pointer= 0;
int PWMadd  = 50;
double outV  = 0;
double battV = 0;

int key;
char press;
char test[5] = "";
char user[5] = "2019";
char keyPadCode[17] = "123A456B789C*0#D";
uint8_t i = 0, j = 0, k = 0;
uint8_t access = 0;

float sinPWM[160] = {0,
	0.0196362378848791,	0.0392649036630707,	0.0588784281478357,	0.0784692479912056,	0.0980298086005533,
	0.117552567051788,	0.137029994998048,	0.15645458157278,	0.175818836286065,	0.195115291913097,
	0.214336507373689,	0.233475070601691,	0.252523601403226,	0.271474754302633,	0.290321221375019,
	0.309055735064341,	0.327671070985904,	0.346160050712231,	0.364515544541193,	0.382730474245362,
	0.40079781580151,	0.418710602099205,	0.436461925627459,	0.454044941138402,	0.471452868286933,
	0.488678994245352,	0.505716676291956,	0.522559344372598,	0.539200503634223,	0.555633736929408,
	0.571852707290937,	0.587851160375454,	0.603622926875259,	0.619161924897309,	0.634462162308512,
	0.649517739046406,	0.664322849394338,	0.678871784220257,	0.693158933178263,	0.707178786872066,
	0.720925938979512,	0.734395088337361,	0.747581040985522,	0.76047871216994,	0.773083128303372,
	0.7853894288833,	0.79739286836623,	0.809088817997668,	0.820472767597051,	0.831540327296963,
	0.842287229235945,	0.852709329204273,	0.862802608242033,	0.872563174188919,	0.881987263185115,
	0.891071241122718,	0.899811605047113,	0.908204984507785,	0.916248142858023,	0.923937978503036,
	0.931271526095988,	0.938245957681487,	0.944858583786105,	0.951106854455483,	0.95698836023765,
	0.962500833112145,	0.967642147364615,	0.972410320406529,	0.976803513539701,	0.980820032665327,
	0.984458328937264,	0.987716999359291,	0.990594787326133,	0.993090583108034,	0.995203424278685,
	0.996932496086358,	0.998277131768087,	0.999236812806787,	0.999811169131202,	0.999999979258613,
	0.999803170380245,	0.999220818389343,	0.998253147851908,	0.996900531920098,	0.995163492188335,
	0.993042698492166,	0.990538968649966,	0.987653268147567,	0.984386709765951,	0.98074055315214,
	0.97671620433345,	0.972315215175305,	0.967539282782802,	0.962390248846283,	0.956870098931134,
	0.950980961712121,	0.944725108152533,	0.938104950628447,	0.931123041998481,	0.923782074619354,
	0.916084879307666,	0.908034424248284,	0.899633813849746,	0.890886287547151,	0.881795218552965,
	0.872364112556246,	0.862596606370788,	0.852496466532694,	0.842067587847927,	0.8313139918904,
	0.82023982545118,	0.808849358939409,	0.797146984735549,	0.7851372154976,	0.772824682420931,
	0.760214133452403,	0.747310431459474,	0.73411855235498,	0.720643583178331,	0.706890720133851,
	0.692865266587026,	0.678572631019418,	0.66401832494306,	0.649207960775107,	0.634147249673584,
	0.618841999335052,	0.603298111755052,	0.587521580952183,	0.571518490656695,	0.555295011964484,
	0.538857400957403,	0.522211996290799,	0.505365216749202,	0.488323558771125,	0.471093593943911,
	0.453681966469602,	0.436095390602816,	0.418340648061591,	0.400424585412239,	0.382354111429167,
	0.364136194430732,	0.345777859592121,	0.327286186236307,	0.308668305104134,	0.289931395604562,
	0.271082683046154,	0.252129435850858,	0.233078962751164,	0.213938609971723,	0.194715758396495,
	0.175417820722547,	0.156052238601573,	0.136626479770252,	0.117148035170546,	0.0976244160610511,
	0.078063151120514,	0.05847178354463,	0.0388578681372417,	0.0192289683970647
};




int main(void)
{
	DDRD = (1<<DDD4)|(1<<DDD5); //PWM Pins
	DDRC = (1<<DDC6)|(1<<DDC7); //LED & Buzzer
	DDRA = (1<<DDA7); //SD; IR2110
	
	PORTD |=  (1<<PWMA);
	PORTD &= ~(1<<PWMB);
	PORTA  =  (1<<SD);
	PORTC  =  (1<<LED);
	PORTC &= ~(1<<BUZZ);
	
	//cli();//Disable Interrupts
	
	display.init();
	_delay_ms(100);
	display.clear();
	
	
	analogRefInit(VREFF_AVCC);
	_delay_ms(200);
	display.clear();
	
	TCCR1A = 0xA1;//0b10100001;
	TCCR1B = 0x01;//0b00000001;
	TCCR0  = 0x0A;//0b00001010;
	OCR0   = 123;

	TIMSK |=(1 << OCIE0);
	
	sei();//Enable Interrupt
	while (1)
	{
	}
}

ISR(TIMER0_COMP_vect)
{
	if(pointer>160 && OK==0){
		pointer=0;
		OK=1;
	}
	if(pointer>160 && OK==1){
		pointer=0;
		OK=0;
	}
	
	x=sinPWM[pointer]*PWMadd;
	pointer=pointer+1;
	
	if(OK==0){
		OCR1A = 0;
		OCR1B = x;
	}
	if(OK==1){
		OCR1B = 0;
		OCR1A = x;
	}
}


